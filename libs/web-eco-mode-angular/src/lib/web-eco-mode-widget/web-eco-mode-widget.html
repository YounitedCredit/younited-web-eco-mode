<section class="eco-widget" [class.collapsed]="!isWidgetExpanded()" aria-label="Eco Mode Widget">
  <div class="eco-widget-header"
       (click)="toggleWidget()"
       (keydown.enter)="toggleWidget()"
       (keydown.space)="toggleWidget(); $event.preventDefault()"
       tabindex="0"
       role="button"
       [attr.aria-expanded]="isWidgetExpanded()">
    <span class="eco-icon" aria-hidden="true">🌱</span>
    @if (isWidgetExpanded()) {
    <h3>Eco Mode</h3>
    }

    <span class="eco-mode-badge header-badge" [class]="'mode-' + ecoModeLevel().toLowerCase()">{{ ecoModeLevel() }}</span>

    <button
      class="widget-toggle-button"

      (keydown.enter)="toggleWidget()"
      (keydown.space)="toggleWidget(); $event.preventDefault()"
      [attr.aria-expanded]="isWidgetExpanded()"
      [attr.aria-label]="isWidgetExpanded() ? 'Collapse widget' : 'Expand widget'"
      type="button">
      <span class="widget-toggle-icon" aria-hidden="true">{{ isWidgetExpanded() ? '−' : '+' }}</span>
    </button>
  </div>
  @if (isWidgetExpanded()) {
    <div class="eco-widget-content">
    <div class="eco-mode-slider-container">
        <label for="eco-mode-slider" class="slider-label">Choose your Eco Mode Level</label>
        <div class="slider-wrapper">
          <span class="slider-marker">Low Impact</span>
          <input
            type="range"
            id="eco-mode-slider"
            class="eco-mode-slider"
            min="0"
            max="2"
            step="1"
            [value]="getEcoModeSliderValue()"
            (input)="onEcoModeChange($event)"
            [attr.aria-label]="'Select eco mode level: ' + ecoModeLevel()"
            [attr.aria-valuetext]="ecoModeLevel()">
          <span class="slider-marker">High Impact</span>
        </div>
      </div>
    <div class="eco-power-bar">
      <div class="eco-power-header">
        <span class="label" id="eco-score-label">Device Eco Score</span>
      </div>
      <p class="eco-score-explanation">This is the eco impact score according to your device context</p>
      <div class="eco-score-display">
        <span class="score-number">{{ ecoImpactScore() }}</span>
        <span class="score-max">/ 100</span>
      </div>
    </div>
    <div class="network-quality">
      <button
        class="network-quality-header"
        (click)="toggleNetworkDetails()"
        (keydown.enter)="toggleNetworkDetails()"
        (keydown.space)="toggleNetworkDetails(); $event.preventDefault()"
        [attr.aria-expanded]="showNetworkDetails()"
        aria-controls="network-details"
        type="button">
        <span class="label">Network Quality</span>
        <span class="toggle-icon" aria-hidden="true">{{ showNetworkDetails() ? '▼' : '▶' }}</span>
      </button>
      <div class="network-quality-summary" aria-live="polite">
        <span class="value" id="network-score-label">Score: {{ networkQuality().score }} / 100</span>
        <span class="assessment" [attr.aria-label]="'Network assessment: ' + networkQuality().details.assessment">{{ networkQuality().details.assessment }}</span>
      </div>
      @if (showNetworkDetails()) {
        <div class="network-quality-details" id="network-details" aria-labelledby="network-score-label">
          <div class="detail-item">
            <span class="detail-label">Connection Type:</span>
            <span class="detail-value">{{ networkQuality().details.connectionType || 'N/A' }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Downlink Speed:</span>
            <span class="detail-value">{{ networkQuality().details.downlinkSpeed || 'N/A' }} Mbps</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">RTT:</span>
            <span class="detail-value">{{ networkQuality().details.rtt || 'N/A' }} ms</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Online Status:</span>
            <span class="detail-value">{{ networkQuality().details.isOnline ? 'Online' : 'Offline' }}</span>
          </div>
          @if (networkQuality().details.avgLoadTime) {
            <div class="detail-item">
              <span class="detail-label">Avg Load Time:</span>
              <span class="detail-value">{{ networkQuality().details.avgLoadTime }} ms</span>
            </div>
          }
        </div>
      }
    </div>
    @if (batteryInfo()) {
      <div class="battery-info">
        <button
          class="battery-info-header"
          (click)="toggleBatteryDetails()"
          (keydown.enter)="toggleBatteryDetails()"
          (keydown.space)="toggleBatteryDetails(); $event.preventDefault()"
          [attr.aria-expanded]="showBatteryDetails()"
          aria-controls="battery-details"
          type="button">
          <span class="label">Battery Information</span>
          <span class="toggle-icon" aria-hidden="true">{{ showBatteryDetails() ? '▼' : '▶' }}</span>
        </button>
        @if (batteryInfo()!.supported) {
          <div class="battery-info-summary" aria-live="polite">
            <span class="value" id="battery-level-label">Level: {{ batteryInfo()!.levelPercentage }}%</span>
            <span class="status" [attr.aria-label]="'Battery status: ' + (batteryInfo()!.charging ? 'Charging' : 'Not charging')">
              {{ batteryInfo()!.charging ? '🔌 Charging' : '🔋 On Battery' }}
            </span>
          </div>
          @if (showBatteryDetails()) {
            <div class="battery-info-details" id="battery-details" aria-labelledby="battery-level-label">
              <div class="detail-item">
                <span class="detail-label">Charging:</span>
                <span class="detail-value">{{ batteryInfo()!.charging ? 'Yes' : 'No' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Battery Level:</span>
                <span class="detail-value">{{ batteryInfo()!.levelPercentage }}% ({{ batteryInfo()!.level }})</span>
              </div>
              @if (batteryInfo()!.charging && batteryInfo()!.chargingTime) {
                <div class="detail-item">
                  <span class="detail-label">Time to Full:</span>
                  <span class="detail-value">{{ (batteryInfo()!.chargingTime! / 60) | number:'1.0-0' }} minutes</span>
                </div>
              }
              @if (!batteryInfo()!.charging && batteryInfo()!.dischargingTime) {
                <div class="detail-item">
                  <span class="detail-label">Time Remaining:</span>
                  <span class="detail-value">{{ (batteryInfo()!.dischargingTime! / 60) | number:'1.0-0' }} minutes</span>
                </div>
              }
            </div>
          }
        } @else {
          <div class="battery-info-summary" aria-live="polite">
            <span class="value">Not supported</span>
          </div>
        }
      </div>
    }
  </div>
  }
</section>

